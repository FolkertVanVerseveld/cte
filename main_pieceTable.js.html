<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>main/pieceTable.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-connector-Connector.html">Connector</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#addEventListener">addEventListener</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#close">close</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#getURLString">getURLString</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#isOpen">isOpen</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#listenToMsg">listenToMsg</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#reload">reload</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#removeEventListener">removeEventListener</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#request">request</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#send">send</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#setUp">setUp</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#waitUntillOpen">waitUntillOpen</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-TabType-Tab.html">Tab</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-AddPieceButton.html">AddPieceButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-AddPieceButton.html#click">click</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-connector.html">connector</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-cursor.html">cursor</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html">Editor/EditorPiece</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html#gutterSelectMarker">gutterSelectMarker</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html#initializeEditor">initializeEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html#initializeEvents">initializeEvents</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html#lineToRelativeLine">lineToRelativeLine</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html#relativeLineToLine">relativeLineToLine</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html#setText">setText</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html#unlock">unlock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html#updateDragLength">updateDragLength</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html#updateDragStart">updateDragStart</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html#updateLineNumbers">updateLineNumbers</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html#updateTheme">updateTheme</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Editor_GhostCursor.html">Editor/GhostCursor</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-EditorPiece.html">EditorPiece</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-EditorPiece.html#editorMount">editorMount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-EditorPiece.html#editorUpdate">editorUpdate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-EditorPiece.html#editorViewPortChange">editorViewPortChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-EditorPiece.html#getPreviousState">getPreviousState</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-EditorPiece.html#initializeEditor">initializeEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-EditorPiece.html#keepYInView">keepYInView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-EditorPiece.html#lockDragCancel">lockDragCancel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-EditorPiece.html#lockDragEnd">lockDragEnd</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-EditorPiece.html#lockDragStart">lockDragStart</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-EditorPiece.html#themeChange">themeChange</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-ErrorMessenger.html">ErrorMessenger</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-fileManager.html">fileManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-fileManager.html#.fileChangeRequest">fileChangeRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-fileManager.html#.locationChange">locationChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-fileManager.html#.nameChange">nameChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-fileManager.html#.newFile">newFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-fileManager.html#.removeItem">removeItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-fileManager.html#.uploadFile">uploadFile</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-fileTracker.html">fileTracker</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-fileTree.html">fileTree</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-fileTree.html#fileClick">fileClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-fileTree.html#optionClicked">optionClicked</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-fileTree.html#rightClick">rightClick</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-FileTreeItem.html">FileTreeItem</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-LandingPage.html">LandingPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-LandingPage.html#open">open</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-multiEditor.html">multiEditor</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-optionParser.html">optionParser</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-optionParser.html#.getSettings">getSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-optionParser.html#.resetServerURL">resetServerURL</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-optionParser.html#.setLocalWorkspace">setLocalWorkspace</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-optionParser.html#.setServerURL">setServerURL</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-optionParser.html#~correctJSON">correctJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-optionParser.html#~setter">setter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-optionParser.html#~writeJSON">writeJSON</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-pieceTable.html">pieceTable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#._create">_create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.convertBlockToJS">convertBlockToJS</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.convertChangeToJS">convertChangeToJS</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.convertPieceToJS">convertPieceToJS</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.convertPieceToPy">convertPieceToPy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.convertTextBlocksToPy">convertTextBlocksToPy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.convertTextBlockToPy">convertTextBlockToPy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.convertToJS">convertToJS</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.convertToPy">convertToPy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.edit">edit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.getBlock">getBlock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.getFile">getFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.getPieceByPieceID">getPieceByPieceID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.getPieceIndexByPieceID">getPieceIndexByPieceID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.getRange">getRange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.getRangeById">getRangeById</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.getStart">getStart</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.getTextByPieceID">getTextByPieceID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.indexOffsetCompare">indexOffsetCompare</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.indexOffsetRangeSort">indexOffsetRangeSort</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.len">len</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.lengthBetween">lengthBetween</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.lineToTableIndex">lineToTableIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.rangeToAnchoredLength">rangeToAnchoredLength</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-pieceTable.html#.stitch">stitch</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Placeholder.html">Placeholder</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-RandomColor.html">RandomColor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-RandomColor.html#.getRandomColor">getRandomColor</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-ScrollBar.html">ScrollBar</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ScrollBar.html#mousedown">mousedown</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ScrollBar.html#mousemove">mousemove</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ScrollBar.html#mouseup">mouseup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ScrollBar.html#render">render</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Sidebar.html">Sidebar</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#createItem">createItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#downloadFile">downloadFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#downloadProject">downloadProject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#getFilePath">getFilePath</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#home">home</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#itemNames">itemNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#listenToFileSave">listenToFileSave</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#openFile">openFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#openFolder">openFolder</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#openSocketUpdateTree">openSocketUpdateTree</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#previous">previous</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#promptBox">promptBox</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#relocate">relocate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#removeItem">removeItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#renameItem">renameItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#requestProject">requestProject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#sameType">sameType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#saveFile">saveFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#saveToDisk">saveToDisk</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#updateFileTree">updateFileTree</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#uploadDir">uploadDir</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#uploadDirRecursive">uploadDirRecursive</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#uploadFile">uploadFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sidebar.html#uploadFileHelper">uploadFileHelper</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Tabs.html">Tabs</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Tabs.html#scrollTabs">scrollTabs</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Tabs.html#tabClick">tabClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Tabs.html#tabRemove">tabRemove</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-TabType.html">TabType</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-ThemeSwitch.html">ThemeSwitch</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ThemeSwitch.html#turnOff">turnOff</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ThemeSwitch.html#turnOn">turnOn</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">main/pieceTable.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module pieceTable
 */

const uuid = require('uuid/v4')
const { mergeLeft, clone } = require('ramda')

/**
 * A text block that contains an array of text lines.
 * @typedef {Object} TextBlock a textblock object
 * @property {boolean} open signals whether you can modify the TextBlock
 * @property {string[]} lines An array with text lines
 */

/**
 * A piece containing information about how to read the buffer of a corresponding block.
 * @typedef {Object} Piece A piece object
 * @property {string} pieceID a unique piece ID
 * @property {string|number} blockID a block ID that corresponds to a block
 * @property {number} start where we should start reading in the text buffer of the block
 * @property {number} length the length of the text of the piece
 */

/**
 * A piece table
 * Text file data structure consisting of the original file together with
 * so-called "edit-blocks" (see the TextBlock class), for which a table is
 * used to couple these seperate blocks into one single file.
 * @typedef {Object} PieceTable a piece table object
 * @property {Object.&lt;string, TextBlock>} textBlocks a dictionary of textblocks
 * @property {Piece[]} table a table containing pieces
 */

/**
 * @typedef {Object} Position
 * @property {number} index
 * @property {number} offset
 */

/**
 * @typedef {Object} Range
 * @property {number} start inclusive start
 * @property {number} end exclusive end
 */

/**
 * An update object containing the update that was broadcast.
 * @typedef {Object} Update an update object
 * @property {string} filePath In which file the update happened
 * @property {PieceTable} pieceTable the updated piece table
 * @property {TextBlock} changedBlock the block that is changed
 */

/**
 * A FilePiece object that can be rendered via an editor piece.
 * @typedef {Object} FilePiece a file piec object
 * @property {string} pieceID the piece ID of the corresponding piece
 * @property {string[]} text the text of the file
 * @property {boolean} open whether the block is open
 * @property {string} username username of the person that locked the piece
 */

/**
 * Returns a create functio that can create a PieceTable.
 * @param {Function} UUID a function that can create an UUID.
 */
export function _create (UUID) {
  /**
   * Creates a new piece table object
   * @param {string|string[]} text The text we want in the piece table
   * @returns {PieceTable} a piece table
   */
  return function c (text) {
    const lines = Array.isArray(text) ? text : text.split('\n')
    return {
      textBlocks: {
        '0': {
          open: false,
          lines: lines
        }
      },
      table: [{
        pieceID: UUID(),
        blockID: 0,
        start: 0,
        length: text.length === 0 ? 0 : lines.length,
        username: 'hans'
      }]
    }
  }
}

export let create = _create(uuid)

/**
 * Converts the python representation of the piece table to the js
 * represenation.
 * @param {Object} pyPiece The python representation of an piece table
 * @returns {PieceTable} a pieceTable
 */
export function convertToJS (pyPieceTable) {
  return {
    textBlocks: pyPieceTable['block_list'].reduce(convertBlockToJS, {}),
    table: pyPieceTable['piece_table'].map(convertPieceToJS)
  }
}

/**
 * Converts an individual block from python to javascript and adds it to obj.
 * @param {Object.&lt;string, TextBlock>} obj A TextBlock dictionary can also be an empty object
 * @param {any[]} block The python representation of an textblock
 * @returns {Object.&lt;string, TextBlock>} text blocks
 */
export function convertBlockToJS (obj, [blockID, closed, lines]) {
  obj = clone(obj)
  obj[blockID] = {
    open: !closed,
    lines
  }
  return obj
}

/**
 * Convert a python piece to a js piece.
 * @param {any[]} piece The python representation of a piece
 * @returns {Piece} the js representation of a piece.
 */
export function convertPieceToJS ([pieceID, blockID, start, length, username]) {
  return {
    pieceID,
    blockID,
    start,
    length,
    username
  }
}

/**
 * Converts the indivual properties of a python update to js.
 * @param {Object.&lt;string, TextBlock>} textBlocks A Textblock dictionary
 * @param {Object} update the python update object
 * @returns {Update} A js Update object
 */
export function convertChangeToJS (textBlocks, update) {
  return {
    filePath: update['file_path'],
    pieceTable: {
      textBlocks: update['changed_blocks'].reduce(convertBlockToJS, textBlocks),
      table: update['piece_table'].map(convertPieceToJS)
    },
    changedBlocks: update['changed_blocks'].reduce(convertBlockToJS, {})
  }
}

/**
 * Converts a javascript piecetable to python
 * @param {PieceTable} pieceTable A pieceTable to convert
 * @returns {Object} an python piece table to send over sockets
 */
export function convertToPy ({ textBlocks, table }) {
  return {
    block_list: convertTextBlocksToPy({ textBlocks, table }),
    piece_table: table.map(convertPieceToPy)
  }
}

/**
 * Convert the blocks in a piecetable to python.
 * @param {PieceTable} pieceTable A pieceTable
 * @returns {any[]} a block list
 */
export function convertTextBlocksToPy ({ textBlocks, table }) {
  return table.map(({ blockID }) => {
    return convertTextBlockToPy(textBlocks, blockID)
  })
}

/**
 * Convert individual javascript textblock to python
 * @param {Object.&lt;string, TextBlock>} textBlocks
 * @param {number} blockID The ID of a block
 * @return {any[]} a block
 */
export function convertTextBlockToPy (textBlocks, blockID) {
  const { open, lines } = textBlocks[blockID]
  return [blockID, !open, lines]
}

/**
 * Convert a single pice from javascript to python.
 * @param {Piece} piece A piece to convert
 * @returns {any[]} piece
 */
export function convertPieceToPy ({ pieceID, blockID, start, length }) {
  return [pieceID, blockID, start, length]
}

/**
 * Returns the length of the stitched file according to the table.
 * @param {Piece[]} table A table containing pieces
 * @returns {number} the length of the table
 */
export function len (table) {
  return table.reduce((total, curr) => total + curr.length, 0)
}

/**
 * Return A and B in order.
 * @param {Object} A
 * @param {Object} B
 */
export function indexOffsetRangeSort (A, B) {
  const comp = indexOffsetCompare(A, B)
  if (comp > 0) {
    return [ B, A ]
  } else {
    return [ A, B ]
  }
}

/**
 * Determine the order of A and B.
 * @param {Object} A
 * @param {Object} B
 */
export function indexOffsetCompare (A, B) {
  if (A.piece &lt; B.piece || (A.piece === B.piece &amp;&amp; A.line &lt; B.line)) {
    return -1
  } else if (A.piece > B.piece || (A.piece === B.piece &amp;&amp; A.line > B.line)) {
    return 1
  } else {
    return 0
  }
}

/**
 * Make a new piece based on selected lines.
 * @param {PieceTable} table A piece table
 * @param {number} idxA
 * @param {number} offsetA
 * @param {number} idxB
 * @param {number} offsetB
 */
export function rangeToAnchoredLength (table, idxA, offsetA,
  idxB, offsetB) {
  let startPiece, endPiece
  if (idxA &lt; idxB || (idxA === idxB &amp;&amp; offsetA &lt;= offsetB)) {
    startPiece = { piece: idxA, offset: offsetA }
    endPiece = { piece: idxB, offset: offsetB }
  } else {
    startPiece = { piece: idxB, offset: offsetB }
    endPiece = { piece: idxA, offset: offsetA }
  }

  let interLines = 0
  for (let i = startPiece.piece; i &lt; endPiece.piece; i++) {
    interLines += table.table[i].length
  }

  return {
    index: startPiece.piece,
    offset: startPiece.offset,
    length: interLines - startPiece.offset + endPiece.offset + 1
  }
}

/**
 * Compute number of lines between two locations in the piece table
 * @param {Piece[]} table a piece table
 * @param {Piece} startpiece the piece where to start counting
 * @param {int} startoffset the offset from the start piece
 * @param {piece} endpiece the piece where to stop counting
 * @param {int} endoffset the offset from the end piece
 */
export function lengthBetween (table, startpiece, startoffset,
  endpiece, endoffset) {
  let accumulator = 0
  for (let i = getPieceIndexByPieceID(table, startpiece);
    i &lt; getPieceByPieceID(table, endpiece); i++) {
    accumulator += table[i].length
  }
  return accumulator - startoffset + endoffset + 1
}

/**
 * Returns the corresponding piece index and piece offset
 * for a given file line. When line number is invalid returns 0, 0.
 * @param {Piece[]} table a piece table
 * @param {number} lineNumber the number where we need the piece of
 * @returns {Position} the postion in table index
 */
export function lineToTableIndex (table, lineNumber) {
  let pieceStart = 0
  for (let i = 0; i &lt; table.length; i++) {
    const pieceLength = table[i].length
    if (lineNumber >= pieceStart &amp;&amp; lineNumber &lt; pieceStart + pieceLength) {
      return {
        index: i,
        offset: lineNumber - pieceStart
      }
    }
    pieceStart += pieceLength
  }
  return {
    index: 0,
    offset: 0
  }
}

/**
 * Returns the line at which the given piece (table index) begins within
 * the stitched file.
 * @param {Piece[]} table a piece table
 * @param {number} index table index
 * @returns {number} the start
 */
export function getStart (table, index) {
  return len(table.slice(0, index))
}

/**
 * Calculates which pieces cover a certain line range
 * @param {Piece[]} table a piece table
 * @param {number} lineNumber the line number where to start the range
 * @param {number} length the amount of lines in the range
 * @returns {Range} a range of pieces which cover the given line range
 */
export function getRange (table, lineNumber, length) {
  const { index, offset } = lineToTableIndex(table, lineNumber)
  let rest = length - (table[index].length - offset)
  let lastOff = 1

  while (rest > 0 &amp;&amp; index + lastOff &lt; table.length) {
    rest -= table[index + lastOff].length
    lastOff++
  }

  return {
    start: index,
    end: index + lastOff
  }
}

/**
 * Determine the start and end pieces based on ID's.
 * @param {Piece[]} table a piece table
 * @param {PieceID} startPieceID the piece ID of the first piece in the range
 * @param {PieceID} endPieceID the piece ID of the last piece in the range
 * @returns {Range} a range of pieces which cover the given piece ID's
 */
export function getRangeById (table, startPieceID, endPieceID) {
  const startPiece = getPieceIndexByPieceID(startPieceID)
  const endPiece = getPieceIndexByPieceID(endPieceID)

  return {
    start: startPiece,
    end: endPiece
  }
}

/**
 * Get a block by pieceID
 * @param {pieceTable} pieceTable a piece table
 * @param {string} pieceID the piece ID of the block
 * @returns {TextBlock} the corresponding TextBlock
 */
export function getBlock ({ textBlocks, table }, pieceID) {
  const piece = getPieceByPieceID(table, pieceID)
  return textBlocks[piece.blockID]
}

/**
 * Return a piece with corresponding ID.
 * @param {Piece[]} table a piece table
 * @param {string} pieceID the piece ID of the piece
 * @returns {Piece} the corresponding piece
 */
export function getPieceByPieceID (table, pieceID) {
  return table.find(x => x.pieceID === pieceID)
}

/**
 * Get the piece index based on piece ID.
 * @param {Piece[]} table a piece table
 * @param {string} pieceID the piece id of the piece
 * @returns {number} the index of the corresponding piece
 */
export function getPieceIndexByPieceID (table, pieceID) {
  return table.findIndex(x => x.pieceID === pieceID)
}

/**
 * Returns the new stitched file according to the piece table.
 * @param {PieceTable} pieceTable a piece table
 * @returns {string[]} the stiched file
 */
export function stitch ({ textBlocks, table }) {
  return [].concat(
    ...table.map(({ blockID, start, length }) =>
      textBlocks[blockID].lines.slice(start, start + length)
    )
  )
}

/**
 * Get the text from a piece based on the PieceID
 * @param {PieceTable} pieceTable a piece table
 * @param {string} pieceID a piece ID that corresponds to a block of text
 * @returns {string[]} the text of the corresponding block
 */
export function getTextByPieceID ({ textBlocks, table }, pieceID) {
  const { blockID, start, length } = getPieceByPieceID(table, pieceID)
  const block = textBlocks[blockID]
  return block.lines.slice(start, start + length)
}

/**
 * Get file pieces from the piecetable.
 * @param {PieceTable} a piece table
 * @returns {FilePiece[]} a list of file pieces
 */
export function getFile ({ textBlocks, table }) {
  return table.filter(({ length }) => length > 0).map(({ pieceID, username }) => {
    return {
      pieceID,
      text: getTextByPieceID({ textBlocks, table }, pieceID),
      open: getBlock({ textBlocks, table }, pieceID).open,
      username
    }
  })
}

/**
 * Computes a new piece table based on lines changed in a certain piece.
 * @param {PieceTable} pieceTable a piece table
 * @param {number} pieceID the piece ID of the piece that contains the updated text
 * @param {string[]} lines the updated text of the piece
 * @return {PieceTable} an updated piece table.
 */
export function edit ({ textBlocks, table }, pieceID, lines) {
  const index = getPieceIndexByPieceID(table, pieceID)
  const piece = table[index]
  const block = textBlocks[piece.blockID]

  const newPiece = {
    ...piece,
    length: lines.length
  }

  // Ensure we make a deep copy of the table and the textblocks
  const newTable = clone(table)
  newTable[index] = newPiece
  const newBlock = mergeLeft({ lines }, block)
  const newTextblocks = clone(textBlocks)

  newTextblocks[piece.blockID] = newBlock

  return {
    table: newTable,
    textBlocks: newTextblocks
  }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.2</a> on Fri Jun 28 2019 22:20:26 GMT+0200 (Central European Summer Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
