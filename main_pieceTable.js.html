<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>main/pieceTable.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-connector-Connector.html">Connector</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#addEventListener">addEventListener</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#close">close</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#getURLString">getURLString</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#isOpen">isOpen</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#listenToMsg">listenToMsg</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#reload">reload</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#removeEventListener">removeEventListener</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#request">request</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#send">send</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#setUp">setUp</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-connector-Connector.html#waitUntillOpen">waitUntillOpen</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Tab.html">Tab</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-connector.html">connector</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html">Editor/EditorPiece</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Editor_EditorPiece.html#initializeEditor">initializeEditor</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-fileTracker.html">fileTracker</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_create">_create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#convertBlockToJS">convertBlockToJS</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#convertChangeToJS">convertChangeToJS</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#convertPieceToPy">convertPieceToPy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#convertTableTojs">convertTableTojs</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#convertTextBlocksToPy">convertTextBlocksToPy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#convertTextBlockToPy">convertTextBlockToPy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#convertToJS">convertToJS</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#convertToPy">convertToPy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#correctJSON">correctJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#edit">edit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#fileChangeRequest">fileChangeRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#files">files</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getBlock">getBlock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getFile">getFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getPieceByPieceID">getPieceByPieceID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getPieceIndexByPieceID">getPieceIndexByPieceID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRange">getRange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRangeById">getRangeById</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getSettings">getSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getStart">getStart</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getTextByPieceID">getTextByPieceID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#len">len</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#lengthBetween">lengthBetween</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#lineToTableIndex">lineToTableIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#locationChange">locationChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#nameChange">nameChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#newFile">newFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#rangeToAnchoredLength">rangeToAnchoredLength</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeItem">removeItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setLocalWorkspace">setLocalWorkspace</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setServerURL">setServerURL</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setter">setter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#stitch">stitch</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#uploadFile">uploadFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#writeJSON">writeJSON</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">main/pieceTable.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const uuid = require('uuid/v4')
const { mergeLeft, clone } = require('ramda')

/**
 * A text block
 * @typedef {Object} TextBlock
 * @property {boolean} open signals whether you can modify the TextBlock
 * @property {string[]} lines An array with text lines
 */

/**
 * @typedef {Object} Piece
 * @property {string} pieceID
 * @property {string|number} blockID
 * @property {number} start
 * @property {number} length
 */

/**
 * A piece table
 * Text file data structure consisting of the original file together with
 * so-called "edit-blocks" (see the TextBlock class), for which a table is
 * used to couple these seperate blocks into one single file.
 * @typedef {Object} PieceTable
 * @property {Object.&lt;string, TextBlock>} textBlocks
 * @property {Piece[]} table
 */

/**
 * @typedef {Object} Position
 * @property {number} index
 * @property {number} offset
 */

/**
 * @typedef {Object} Range
 * @property {number} start inclusive start
 * @property {number} end exclusive end
 */

/**
 * @typedef {Object} Update
 * @property {string} filePath
 * @property {PieceTable} pieceTable the updated piece table
 * @property {TextBlock} changedBlock the block that is changed
 */

/**
 * @typedef FilePiece
 * @property {string} pieceID
 * @property {string[]} text the text of the file
 * @property {boolean} open whether the block is open
 * @property {string} username username of the person that locked the piece
 */

/**
 * Returns a create function
 * @param {Function} UUID
 */
export function _create (UUID) {
  /**
   * Creates a new piece table object
   * @param {string|string[]} text
   * @returns {PieceTable} a piece table
   */
  return function c (text) {
    const lines = Array.isArray(text) ? text : text.split('\n')
    return {
      textBlocks: {
        '0': {
          open: false,
          lines: lines
        }
      },
      table: [{
        pieceID: UUID(),
        blockID: 0,
        start: 0,
        length: text.length === 0 ? 0 : lines.length,
        username: 'hans'
      }]
    }
  }
}

export let create = _create(uuid)

/**
 * Converts the python representation of the piece table to the js
 * represenation.
 * @param {Object} pyPiece
 * @returns {PieceTable} a pieceTable
 */
export function convertToJS (pyPieceTable) {
  return {
    textBlocks: pyPieceTable['block_list'].reduce(convertBlockToJS, {}),
    table: pyPieceTable['piece_table'].map(convertTableTojs)
  }
}

/**
 * @param {Object.&lt;string, TextBlock>} obj
 * @param {any[]} block
 * @returns {Object.&lt;string, TextBlock>} text blocks
 */
export function convertBlockToJS (obj, [blockID, closed, lines]) {
  obj = clone(obj)
  obj[blockID] = {
    open: !closed,
    lines
  }
  return obj
}

/**
 * @param {any[]} piece
 * @returns {Piece}
 */
export function convertTableTojs ([pieceID, blockID, start, length, username]) {
  return {
    pieceID,
    blockID,
    start,
    length,
    username
  }
}

/**
 * @param {Object.&lt;string, TextBlock>} textBlocks
 * @param {Object} update
 * @returns {Update}
 */
export function convertChangeToJS (textBlocks, update) {
  return {
    filePath: update['file_path'],
    pieceTable: {
      textBlocks: update['changed_blocks'].reduce(convertBlockToJS, textBlocks),
      table: update['piece_table'].map(convertTableTojs)
    },
    changedBlocks: update['changed_blocks'].reduce(convertBlockToJS, {})
  }
}

/**
 * @param {PieceTable} pieceTable
 * @returns {Object} an python piece table to send over sockets
 */
export function convertToPy ({ textBlocks, table }) {
  return {
    block_list: convertTextBlocksToPy({ textBlocks, table }),
    piece_table: table.map(convertPieceToPy)
  }
}

/**
 * @param {PieceTable} pieceTable
 * @returns {any[]} a block list
 */
export function convertTextBlocksToPy ({ textBlocks, table }) {
  return table.map(({ blockID }) => {
    return convertTextBlockToPy(textBlocks, blockID)
  })
}

/**
 * @param {Object.&lt;string, TextBlock>} textBlocks
 * @param {number} blockID
 * @return {any[]} a block
 */
export function convertTextBlockToPy (textBlocks, blockID) {
  const { open, lines } = textBlocks[blockID]
  return [blockID, !open, lines]
}

/**
 * @param {Piece} piece
 * @returns {any[]} piece
 */
export function convertPieceToPy ({ pieceID, blockID, start, length }) {
  return [pieceID, blockID, start, length]
}

/**
 * Returns the length of the stitched file according to the table.
 * @param {Piece[]} table
 * @returns {number} the length of the table
 */
export function len (table) {
  return table.reduce((total, curr) => total + curr.length, 0)
}

export function indexOffsetRangeSort (A, B) {
  const comp = indexOffsetCompare(A, B)
  if (comp > 0) {
    return [ B, A ]
  } else {
    return [ A, B ]
  }
}

export function indexOffsetCompare (A, B) {
  if (A.piece &lt; B.piece || (A.piece === B.piece &amp;&amp; A.line &lt; B.line)) {
    return -1
  } else if (A.piece > B.piece || (A.piece === B.piece &amp;&amp; A.line > B.line)) {
    return 1
  } else {
    return 0
  }
}

/**
 *
 * @param {*} table
 * @param {*} idxA
 * @param {*} offsetA
 * @param {*} idxB
 * @param {*} offsetB
 */
export function rangeToAnchoredLength (table, idxA, offsetA,
  idxB, offsetB) {
  let startPiece, endPiece
  if (idxA &lt; idxB || (idxA === idxB &amp;&amp; offsetA &lt;= offsetB)) {
    startPiece = { piece: idxA, offset: offsetA }
    endPiece = { piece: idxB, offset: offsetB }
  } else {
    startPiece = { piece: idxB, offset: offsetB }
    endPiece = { piece: idxA, offset: offsetA }
  }

  let interLines = 0
  for (let i = startPiece.piece; i &lt; endPiece.piece; i++) {
    interLines += table.table[i].length
  }

  return {
    index: startPiece.piece,
    offset: startPiece.offset,
    length: interLines - startPiece.offset + endPiece.offset + 1
  }
}

/**
 * Compute number of lines between two locations in the piece table
 * @param {Piece[]} table
 * @param {*} start
 * @param {*} end
 */
export function lengthBetween (table, startpiece, startoffset,
  endpiece, endoffset) {
  let accumulator = 0
  for (let i = getPieceIndexByPieceID(table, startpiece);
    i &lt; getPieceByPieceID(table, endpiece); i++) {
    accumulator += table[i].length
  }
  return accumulator - startoffset + endoffset + 1
}

/**
 * Returns the corresponding piece index and piece offset
 * for a given file line. When line number is invalid returns 0, 0.
 * @param {Piece[]} table
 * @param {number} lineNumber the number where we need the piece of
 * @returns {Position}
 */
export function lineToTableIndex (table, lineNumber) {
  let pieceStart = 0
  for (let i = 0; i &lt; table.length; i++) {
    const pieceLength = table[i].length
    if (lineNumber >= pieceStart &amp;&amp; lineNumber &lt; pieceStart + pieceLength) {
      return {
        index: i,
        offset: lineNumber - pieceStart
      }
    }
    pieceStart += pieceLength
  }
  return {
    index: 0,
    offset: 0
  }
}

/**
 * Returns the line at which the given piece (table index) begins within
 * the stitched file.
 * @param {Piece[]} table
 * @param {number} index table index
 * @returns {number} the start
 */
export function getStart (table, index) {
  return len(table.slice(0, index))
}

/**
 * @param {Piece[]} table
 * @param {number} lineNumber
 * @param {number} length
 * @returns {Range} a range of pieces which cover the given line range
 */
export function getRange (table, lineNumber, length) {
  const { index, offset } = lineToTableIndex(table, lineNumber)
  let rest = length - (table[index].length - offset)
  let lastOff = 1

  while (rest > 0 &amp;&amp; index + lastOff &lt; table.length) {
    rest -= table[index + lastOff].length
    lastOff++
  }

  return {
    start: index,
    end: index + lastOff
  }
}

/**
 * @param {Piece[]} table
 * @param {PieceID} startPieceID
 * @param {PieceID} endPieceID
 * @returns {Range} a range of pieces which cover the given piece ID's
 */
export function getRangeById (table, startPieceID, endPieceID) {
  const startPiece = getPieceIndexByPieceID(startPieceID)
  const endPiece = getPieceIndexByPieceID(endPieceID)

  return {
    start: startPiece,
    end: endPiece
  }
}

/**
 * @param {pieceTable} pieceTable
 * @param {string} pieceID
 * @returns {TextBlock} the corresponding TextBlock
 */
export function getBlock ({ textBlocks, table }, pieceID) {
  const piece = getPieceByPieceID(table, pieceID)
  return textBlocks[piece.blockID]
}

/**
 * @param {Piece[]} table
 * @param {string} pieceID
 * @returns {Piece}
 */
export function getPieceByPieceID (table, pieceID) {
  return table.find(x => x.pieceID === pieceID)
}

/**
 * @param {Piece[]} table
 * @param {string} pieceID
 * @returns {number}
 */
export function getPieceIndexByPieceID (table, pieceID) {
  return table.findIndex(x => x.pieceID === pieceID)
}

/**
 * Returns the new stitched file according to the piece table.
 * @param {PieceTable} pieceTable
 * @returns {string[]} the stiched file
 */
export function stitch ({ textBlocks, table }) {
  return [].concat(
    ...table.map(({ blockID, start, length }) =>
      textBlocks[blockID].lines.slice(start, start + length)
    )
  )
}

/**
 * @param {PieceTable} pieceTable
 * @param {string} pieceID
 * @returns {string[]} the text of the corresponding block
 */
export function getTextByPieceID ({ textBlocks, table }, pieceID) {
  const { blockID, start, length } = getPieceByPieceID(table, pieceID)
  const block = textBlocks[blockID]
  return block.lines.slice(start, start + length)
}

/**
 * @param {PieceTable}
 * @returns {FilePiece[]} a list of file pieces
 */
export function getFile ({ textBlocks, table }) {
  return table.filter(({ length }) => length > 0).map(({ pieceID, username }) => {
    return {
      pieceID,
      text: getTextByPieceID({ textBlocks, table }, pieceID),
      open: getBlock({ textBlocks, table }, pieceID).open,
      username
    }
  })
}

/**
 * @param {PieceTable} pieceTable
 * @param {number} pieceID
 * @param {string[]} lines
 * @return {PieceTable}
 */
export function edit ({ textBlocks, table }, pieceID, lines) {
  const index = getPieceIndexByPieceID(table, pieceID)
  const piece = table[index]
  const block = textBlocks[piece.blockID]

  const newPiece = {
    ...piece,
    length: lines.length
  }

  const newTable = clone(table)
  newTable[index] = newPiece
  const newBlock = mergeLeft({ lines }, block)
  const newTextblocks = clone(textBlocks)
  newTextblocks[piece.blockID] = newBlock

  return {
    table: newTable,
    textBlocks: newTextblocks
  }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.2</a> on Thu Jun 27 2019 15:25:49 GMT+0200 (Central European Summer Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
